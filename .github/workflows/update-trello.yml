name: Update Trello Card Progress

on:
  schedule:
    - cron: '*/30 * * * *'  # –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
  workflow_dispatch:        # –∑–∞–ø—É—Å–∫ –≤—Ä—É—á–Ω—É—é

jobs:
  update-progress:
    runs-on: ubuntu-latest
    steps:
      - name: Update Trello card with progress
        env:
          BOARD_ID: 662jNYs5
          TRELLO_API_KEY: ${{ secrets.TRELLO_API_KEY }}
          TRELLO_TOKEN: ${{ secrets.TRELLO_TOKEN }}
        run: |
          set -e
          echo "üèÅ Start"
          which jq || echo "‚ùå jq not found"

          # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–ø–∏—Å–∫–æ–≤ –Ω–∞ –¥–æ—Å–∫–µ
          lists=$(curl -s "https://api.trello.com/1/boards/$BOARD_ID/lists?key=$TRELLO_API_KEY&token=$TRELLO_TOKEN")
          first_list_id=$(echo "$lists" | jq -r '.[0].id')
          echo "üì¶ –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–∫–∏..."
          echo "$lists"

          # –ü–æ–ª—É—á–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —Å–ø–∏—Å–∫–∞
          cards=$(curl -s "https://api.trello.com/1/lists/$first_list_id/cards?key=$TRELLO_API_KEY&token=$TRELLO_TOKEN")
          card=$(echo "$cards" | jq '.[0]')
          card_id=$(echo "$card" | jq -r '.id')
          card_desc=$(echo "$card" | jq -r '.desc')
          card_name=$(echo "$card" | jq -r '.name')
          echo "üß± –ü–æ–ª—É—á–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏..."
          echo "$cards"
          echo "üìã –û–ø–∏—Å–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏:"
          echo "$card_desc"

          # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—Ç—Ä–æ–∫—É —Å –ü–µ—Ä–∏–æ–¥–æ–º
          period_line=$(echo "$card_desc" | grep -i "–ü–µ—Ä–∏–æ–¥:" | head -n 1)
          
          # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É—è —Å—Ç—Ä–µ–ª–∫—É –∫–∞–∫ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
          period_range=$(echo "$period_line" | sed -E 's/–ü–µ—Ä–∏–æ–¥: (.+) ‚Üí (.+)/\1 ‚Üí \2/')
          start_date=$(echo "$period_range" | awk -F " ‚Üí " '{print $1}')
          end_date=$(echo "$period_range" | awk -F " ‚Üí " '{print $2}')
          echo "‚è≥ –ü–µ—Ä–∏–æ–¥:"
          echo "$period_line"

          # –ü–µ—Ä–µ–≤–æ–¥–∏–º –≤ —Å–µ–∫—É–Ω–¥—ã
          start_ts=$(date -d "$start_date" +%s)
          end_ts=$(date -d "$end_date" +%s)
          now_ts=$(date -u +%s)

          # –°—á–∏—Ç–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
          total=$((end_ts - start_ts))
          passed=$((now_ts - start_ts))
          if [ $passed -lt 0 ]; then passed=0; fi
          if [ $passed -gt $total ]; then passed=$total; fi
          progress=$((100 * passed / total))

          # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é —á–∞—Å—Ç—å —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º, –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞
          clean_title=$(echo "$card_name" | sed -E 's/ *\| –ü—Ä–æ–≥—Ä–µ—Å—Å: [0-9]+%$//')

          # –§–æ—Ä–º–∏—Ä—É–µ–º –Ω–æ–≤—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
          new_title="$clean_title | –ü—Ä–æ–≥—Ä–µ—Å—Å: ${progress}%"

          # –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
          curl -s --request PUT "https://api.trello.com/1/cards/$card_id" \
            --data-urlencode "name=$new_title" \
            --data-urlencode "key=$TRELLO_API_KEY" \
            --data-urlencode "token=$TRELLO_TOKEN"
