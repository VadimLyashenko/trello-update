name: Update Trello Card Title with Time Passed

on:
  schedule:
    - cron: '*/30 * * * *'  # каждые 30 минут
  workflow_dispatch:         # запуск вручную

jobs:
  update-trello:
    runs-on: ubuntu-latest
    steps:
      - name: Check if secrets are available
        run: |
          if [ -z "${{ secrets.TRELLO_API_KEY }}" ]; then
            echo "TRELLO_API_KEY is not set!"
          else
            echo "TRELLO_API_KEY is set."
          fi

          if [ -z "${{ secrets.TRELLO_TOKEN }}" ]; then
            echo "TRELLO_TOKEN is not set!"
          else
            echo "TRELLO_TOKEN is set."
          fi

      - name: Update Trello card with time passed
        env:
          CARD_ID: oJ0W2BuE   # ← твой ID карточки
          START_DATE: '2025-04-18T11:00:00Z'  # ← твоя стартовая дата
          TRELLO_API_KEY: ${{ secrets.TRELLO_API_KEY }}
          TRELLO_TOKEN: ${{ secrets.TRELLO_TOKEN }}
        run: |
          # Получение текущего времени в формате UTC
          now=$(date -u +%s)
          # Преобразование стартовой даты в формат секунд с момента эпохи
          start=$(date -u -d "$START_DATE" +%s)
          
          # Вычисление разницы
          diff=$((now - start))

          # Перевод в дни, часы, минуты
          days=$((diff / 86400))
          hours=$(((diff % 86400) / 3600))
          minutes=$(((diff % 3600) / 60))

          # Формирование нового заголовка для карточки
          new_title="Прошло: ${days} дней ${hours} часов ${minutes} минут"

          # Отправка запроса на обновление заголовка карточки
          curl --request PUT "https://api.trello.com/1/cards/$CARD_ID?key=$TRELLO_API_KEY&token=$TRELLO_TOKEN" \
            --header "Accept: application/json" \
            --data-urlencode "name=$new_title"
