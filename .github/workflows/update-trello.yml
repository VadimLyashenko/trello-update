name: Update Trello Card Progress

on:
  schedule:
    - cron: '*/30 * * * *'  # каждые 30 минут
  workflow_dispatch:        # запуск вручную

jobs:
  update-progress:
    runs-on: ubuntu-latest
    steps:
      - name: Update Trello card with progress
        env:
          BOARD_ID: 662jNYs5
          TRELLO_API_KEY: ${{ secrets.TRELLO_API_KEY }}
          TRELLO_TOKEN: ${{ secrets.TRELLO_TOKEN }}
        run: |
          set -e

          # Получаем список списков на доске
          lists=$(curl -s "https://api.trello.com/1/boards/$BOARD_ID/lists?key=$TRELLO_API_KEY&token=$TRELLO_TOKEN")
          first_list_id=$(echo "$lists" | jq -r '.[0].id')

          # Получаем карточки из первого списка
          cards=$(curl -s "https://api.trello.com/1/lists/$first_list_id/cards?key=$TRELLO_API_KEY&token=$TRELLO_TOKEN")
          card=$(echo "$cards" | jq '.[0]')
          card_id=$(echo "$card" | jq -r '.id')
          card_desc=$(echo "$card" | jq -r '.desc')
          card_name=$(echo "$card" | jq -r '.name')

          # Извлекаем строку с Периодом
          period_line=$(echo "$card_desc" | grep -i "Период: ")
          period_range=$(echo "$period_line" | sed -E 's/Период: (.+)/\1/')
          start_date=$(echo "$period_range" | awk -F " — " '{print $1}')
          end_date=$(echo "$period_range" | awk -F " — " '{print $2}')

          # Переводим в секунды
          start_ts=$(date -d "$start_date" +%s)
          end_ts=$(date -d "$end_date" +%s)
          now_ts=$(date -u +%s)

          # Считаем прогресс
          total=$((end_ts - start_ts))
          passed=$((now_ts - start_ts))
          if [ $passed -lt 0 ]; then passed=0; fi
          if [ $passed -gt $total ]; then passed=$total; fi
          progress=$((100 * passed / total))

          # Удаляем старую часть с прогрессом, если она была
          clean_title=$(echo "$card_name" | sed -E 's/ *\| Прогресс: [0-9]+%$//')

          # Формируем новый заголовок
          new_title="$clean_title | Прогресс: ${progress}%"

          # Обновляем карточку
          curl -s --request PUT "https://api.trello.com/1/cards/$card_id" \
            --data-urlencode "name=$new_title" \
            --data-urlencode "key=$TRELLO_API_KEY" \
            --data-urlencode "token=$TRELLO_TOKEN"
