name: Update Trello Card Progress

on:
  schedule:
    - cron: '*/30 * * * *'  # –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
  workflow_dispatch:        # –∑–∞–ø—É—Å–∫ –≤—Ä—É—á–Ω—É—é

jobs:
  update-progress:
    runs-on: ubuntu-latest
    steps:
      - name: Update Trello card with progress
        env:
          BOARD_ID: 662jNYs5
          TRELLO_API_KEY: ${{ secrets.TRELLO_API_KEY }}
          TRELLO_TOKEN: ${{ secrets.TRELLO_TOKEN }}
        run: |
          set -e
          echo "üèÅ Start"
          which jq || echo "‚ùå jq not found"

          # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–ø–∏—Å–∫–æ–≤ –Ω–∞ –¥–æ—Å–∫–µ
          lists=$(curl -s "https://api.trello.com/1/boards/$BOARD_ID/lists?key=$TRELLO_API_KEY&token=$TRELLO_TOKEN")
          first_list_id=$(echo "$lists" | jq -r '.[0].id')
          echo "üì¶ –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–∫–∏..."
          echo "$lists"

          # –ü–æ–ª—É—á–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —Å–ø–∏—Å–∫–∞
          cards=$(curl -s "https://api.trello.com/1/lists/$first_list_id/cards?key=$TRELLO_API_KEY&token=$TRELLO_TOKEN")
          card=$(echo "$cards" | jq '.[0]')
          card_id=$(echo "$card" | jq -r '.id')
          card_desc=$(echo "$card" | jq -r '.desc')
          card_name=$(echo "$card" | jq -r '.name')
          echo "üß± –ü–æ–ª—É—á–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏..."
          echo "$cards"
          echo "üìã –û–ø–∏—Å–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏:"
          echo "$card_desc"

          # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—Ç—Ä–æ–∫—É —Å –ü–µ—Ä–∏–æ–¥–æ–º, —É—á–∏—Ç—ã–≤–∞—è –∑–≤—ë–∑–¥–æ—á–∫–∏
          period_line=$(echo "$card_desc" | grep -i "–ü–µ—Ä–∏–æ–¥:" | head -n 1)
          
          # –û—á–∏—â–∞–µ–º —Å—Ç—Ä–æ–∫—É –æ—Ç –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤ –∏ –∑–∞–º–µ–Ω—è–µ–º "‚Üí" –Ω–∞ –ø—Ä–æ–±–µ–ª
          cleaned_period=$(echo "$period_line" | sed -E 's/–ü–µ—Ä–∏–æ–¥:\s*//;s/\*//g')
          cleaned_period=$(echo "$cleaned_period" | sed 's/‚Üí/ /')
          
          # –†–∞–∑–¥–µ–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –Ω–∞ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è
          start_date=$(echo "$cleaned_period" | awk '{print $1" "$2}')
          end_date=$(echo "$cleaned_period" | awk '{print $3" "$4}')
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞—Ç—ã –∏ –≤—Ä–µ–º—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ–ª—É—á–µ–Ω—ã
          echo "‚úÖ cleaned_period: $cleaned_period"
          echo "‚úÖ StartDate: $start_date"
          echo "‚úÖ EndDate: $end_date"

          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –ø–æ –¢–æ–∫–∏–æ
          current_time=$(TZ="Asia/Tokyo" date '+%Y-%m-%d %H:%M')
          
          # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º StartDate –∏ EndDate –≤ —Ñ–æ—Ä–º–∞—Ç —Å–µ–∫—É–Ω–¥ —Å –Ω–∞—á–∞–ª–∞ —ç–ø–æ—Ö–∏
          start_ts=$(date -d "$start_date" +%s)
          end_ts=$(date -d "$end_date" +%s)
          current_ts=$(date -d "$current_time" +%s)
          
          # –°—á–∏—Ç–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
          total=$((end_ts - start_ts))
          passed=$((current_ts - start_ts))
          
          if [ $passed -lt 0 ]; then passed=0; fi
          if [ $passed -gt $total ]; then passed=$total; fi
          
          progress=$((100 * passed / total))
          
          echo "üèÅ –ü—Ä–æ–≥—Ä–µ—Å—Å: $progress%"

          # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é —á–∞—Å—Ç—å —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º, –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞
          clean_title=$(echo "$card_name" | sed -E 's/ *\| –ü—Ä–æ–≥—Ä–µ—Å—Å: [0-9]+%$//')

          # –§–æ—Ä–º–∏—Ä—É–µ–º –Ω–æ–≤—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
          new_title="$clean_title | –ü—Ä–æ–≥—Ä–µ—Å—Å: ${progress}%"

          # –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
          curl -s --request PUT "https://api.trello.com/1/cards/$card_id" \
            --data-urlencode "name=$new_title" \
            --data-urlencode "key=$TRELLO_API_KEY" \
            --data-urlencode "token=$TRELLO_TOKEN"
