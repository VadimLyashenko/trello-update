name: Update Trello Card Progress

on:
  schedule:
    - cron: '*/30 * * * *'  # –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
  workflow_dispatch:        # –∑–∞–ø—É—Å–∫ –≤—Ä—É—á–Ω—É—é

jobs:
  update-progress:
    runs-on: ubuntu-latest
    steps:
      - name: Update Trello card with progress
        env:
          BOARD_ID: 662jNYs5
          TRELLO_API_KEY: ${{ secrets.TRELLO_API_KEY }}
          TRELLO_TOKEN: ${{ secrets.TRELLO_TOKEN }}
        run: |
          set -e
          echo "üèÅ Start"

          # –ù–∞–¥—ë–∂–Ω–æ –ø–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–ø–∏—Å–∫–æ–≤ –Ω–∞ –¥–æ—Å–∫–µ (–º–∞–∫—Å. 3 –ø–æ–ø—ã—Ç–∫–∏)
          attempt=0
          while [ $attempt -lt 3 ]; do
            lists=$(curl -s "https://api.trello.com/1/boards/$BOARD_ID/lists?key=$TRELLO_API_KEY&token=$TRELLO_TOKEN")
            if echo "$lists" | jq empty > /dev/null 2>&1; then
              break
            fi
            echo "‚è≥ –ü–æ–ø—ã—Ç–∫–∞ $((attempt+1)) –Ω–µ —É–¥–∞–ª–∞—Å—å. –ü–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ 3 —Å–µ–∫..."
            sleep 3
            attempt=$((attempt+1))
          done
          
          if [ $attempt -eq 3 ]; then
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON –æ—Ç Trello –ø–æ—Å–ª–µ 3 –ø–æ–ø—ã—Ç–æ–∫"
            echo "–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:"
            echo "$lists"
            exit 1
          fi
          
          first_list_id=$(echo "$lists" | jq -r '.[0].id')
          echo "üì¶ –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–∫–∏..."

          # –ü–æ–ª—É—á–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —Å–ø–∏—Å–∫–∞
          cards=$(curl -s "https://api.trello.com/1/lists/$first_list_id/cards?key=$TRELLO_API_KEY&token=$TRELLO_TOKEN")
          card=$(echo "$cards" | jq '.[0]')
          card_id=$(echo "$card" | jq -r '.id')
          card_desc=$(echo "$card" | jq -r '.desc')
          card_name=$(echo "$card" | jq -r '.name')
          echo "üß± –ü–æ–ª—É—á–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏..."

          # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—Ç—Ä–æ–∫—É —Å –ü–µ—Ä–∏–æ–¥–æ–º, —É—á–∏—Ç—ã–≤–∞—è –∑–≤—ë–∑–¥–æ—á–∫–∏
          period_line=$(echo "$card_desc" | grep -i "–ü–µ—Ä–∏–æ–¥:" | head -n 1)
          
          # –û—á–∏—â–∞–µ–º —Å—Ç—Ä–æ–∫—É –æ—Ç –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤ –∏ –∑–∞–º–µ–Ω—è–µ–º "‚Üí" –Ω–∞ –ø—Ä–æ–±–µ–ª
          cleaned_period=$(echo "$period_line" | sed -E 's/–ü–µ—Ä–∏–æ–¥:\s*//;s/\*//g')
          cleaned_period=$(echo "$cleaned_period" | sed 's/‚Üí/ /')
          
          # –†–∞–∑–¥–µ–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –Ω–∞ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è
          start_date=$(echo "$cleaned_period" | awk '{print $1" "$2}')
          end_date=$(echo "$cleaned_period" | awk '{print $3" "$4}')
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞—Ç—ã –∏ –≤—Ä–µ–º—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ–ª—É—á–µ–Ω—ã
          echo "‚úÖ StartDate: $start_date"
          echo "‚úÖ EndDate: $end_date"

          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –ø–æ –¢–æ–∫–∏–æ
          current_time=$(TZ="Asia/Tokyo" date '+%Y-%m-%d %H:%M')
          
          # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º StartDate –∏ EndDate –≤ —Ñ–æ—Ä–º–∞—Ç —Å–µ–∫—É–Ω–¥ —Å –Ω–∞—á–∞–ª–∞ —ç–ø–æ—Ö–∏
          start_ts=$(date -d "$start_date" +%s)
          end_ts=$(date -d "$end_date" +%s)
          current_ts=$(date -d "$current_time" +%s)
          
          # –°—á–∏—Ç–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
          total=$((end_ts - start_ts))
          passed=$((current_ts - start_ts))
          
          if [ $passed -lt 0 ]; then passed=0; fi
          if [ $passed -gt $total ]; then passed=$total; fi
          
          progress=$((100 * passed / total))
          
          echo "üèÅ –ü—Ä–æ–≥—Ä–µ—Å—Å: $progress%"

          # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é —á–∞—Å—Ç—å —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º, –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞
          clean_title=$(echo "$card_name" | sed -E 's/ *\| –ü—Ä–æ–≥—Ä–µ—Å—Å: [0-9]+%$//')

          # –§–æ—Ä–º–∏—Ä—É–µ–º –Ω–æ–≤—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
          new_title="$clean_title | –ü—Ä–æ–≥—Ä–µ—Å—Å: ${progress}%"

          # –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
          curl -s --request PUT "https://api.trello.com/1/cards/$card_id" \
            --data-urlencode "name=$new_title" \
            --data-urlencode "key=$TRELLO_API_KEY" \
            --data-urlencode "token=$TRELLO_TOKEN"

          echo "üèÅ Start second_list updater"

          second_list_id=$(echo "$lists" | jq -r '.[1].id')

          echo "üì¶ –í—Ç–æ—Ä–æ–π —Å–ø–∏—Å–æ–∫ ID: $second_list_id"

          # –ü–æ–ª—É—á–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –∏–∑ –≤—Ç–æ—Ä–æ–≥–æ —Å–ø–∏—Å–∫–∞
          cards=$(curl -s "https://api.trello.com/1/lists/$second_list_id/cards?key=$TRELLO_API_KEY&token=$TRELLO_TOKEN")

          # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é –∫–∞—Ä—Ç–æ—á–∫—É
          echo "$cards" | jq -c '.[]' | while read -r card; do
            name=$(echo "$card" | jq -r '.name')
            id=$(echo "$card" | jq -r '.id')

          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∏–º–µ–Ω–∏ –∫–∞—Ä—Ç–æ—á–∫–∏
          if [ -z "$name" ]; then
            echo "‚è≠ –ü—Ä–æ–ø—É—â–µ–Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞ –±–µ–∑ –∏–º–µ–Ω–∏: –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ."
            continue
          fi

          # –ò—â–µ–º –¥–∞—Ç—É –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ (—Ñ–æ—Ä–º–∞—Ç YYYY-MM-DD HH:MM –ø–æ—Å–ª–µ "‚Äî")
          raw_date=$(echo "$name" | grep -oP '‚Äî \K[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}')
          if [ -z "$raw_date" ]; then
            echo "‚è≠ –ü—Ä–æ–ø—É—â–µ–Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞ –±–µ–∑ –¥–∞—Ç—ã: $name"
            continue
          fi
            
          # –ü–µ—Ä–µ–≤–æ–¥–∏–º –¥–∞—Ç—É –≤ timestamp
          start_ts=$(date -d "$raw_date" +%s || echo 0)

          # –°—á–∏—Ç–∞–µ–º —Ä–∞–∑–Ω–∏—Ü—É
          diff=$((current_ts - start_ts))
          if [ $diff -lt 0 ]; then diff=0; fi

          days=$((diff / 86400))
          hours=$(((diff % 86400) / 3600))
          minutes=$(((diff % 3600) / 60))

          # –§–æ—Ä–º–∏—Ä—É–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É "–ü—Ä–æ—à–ª–æ: ..."
          passed="–ü—Ä–æ—à–ª–æ: ${days} –¥–Ω–µ–π ${hours} —á–∞—Å–æ–≤ ${minutes} –º–∏–Ω—É—Ç"

          # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Å—Ç—Ä–æ–∫—É "–ü—Ä–æ—à–ª–æ: ..." –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è, –µ—Å–ª–∏ –±—ã–ª–∞
          clean_title=$(echo "$name" | sed -E 's/ *–ü—Ä–æ—à–ª–æ:.*//')

          # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É
          new_title="${clean_title} $passed"

          echo "üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É: $new_title"

          # –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏
          curl -s --request PUT "https://api.trello.com/1/cards/$id" \
            --data-urlencode "name=$new_title" \
            --data-urlencode "key=$TRELLO_API_KEY" \
            --data-urlencode "token=$TRELLO_TOKEN"

          done
